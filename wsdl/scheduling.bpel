<!-- loanapproval BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Wed Jan 18 15:24:37 CET 2012 -->
<bpel:process name="scheduling" targetNamespace="http://hospital/scheduling/" suppressJoinFailure="yes" xmlns:sched="http://hospital/scheduling/" xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
	xmlns:plnk="http://docs.oasis-open.org/wsbpel/2.0/plnktype" xmlns:doctor="http://hospital/doctor/" xmlns:patient="http://hospital/patient/" xmlns:room="http://hospital/room/" xmlns:agenda="http://hospital/agenda/"
	xmlns:hos="http://hospital/schema/">

	<!-- Import the client WSDL -->
	<bpel:import location="room.wsdl" namespace="http://hospital/room/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="doctor.wsdl" namespace="http://hospital/doctor/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="patient.wsdl" namespace="http://hospital/patient/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="agenda.wsdl" namespace="http://hospital/agenda/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="scheduling.wsdl" namespace="http://hospital/scheduling/" importType="http://schemas.xmlsoap.org/wsdl/" />

	<!-- partner links TODO -->
	<bpel:partnerLinks>
		<bpel:partnerLink name="link_scheduler" partnerLinkType="sched:schedulingPartnerLinkType" myRole="schedulingService" />
		<bpel:partnerLink name="link_room" partnerLinkType="room:roomLinkType" partnerRole="room" />
	</bpel:partnerLinks>
	
	<!-- variables -->
	<bpel:variables>
		<bpel:variable name="originalRequest" messageType="sched:scheduleTreatmentRequest" />
		<bpel:variable name="finalAnswer" messageType="sched:scheduleTreatmentResponse" />
		
		<bpel:variable name="findRoomRequest" messageType="room:findRoomRequest" />
		<bpel:variable name="findRoomResponse" messageType="room:findRoomResponse" />
		
		<!-- room service, doctor service -->
		<!-- notifications -->
		<!-- callback, rescheduling notifies -->
	</bpel:variables>

	<!-- ================================================================= -->
	<!-- ORCHESTRATION LOGIC -->
	<!-- Set of activities coordinating the flow of messages across the -->
	<!-- services integrated within this business process -->
	<!-- ================================================================= -->
	<bpel:flow name="main">
		<bpel:links>
			<bpel:link name="receive-to-response" />
		</bpel:links>
		<!-- Receive initial request -->
		<bpel:receive partnerLink="link_scheduler" portType="sched:scheduling" operation="scheduleTreatment" variable="originalRequest" createInstance="yes">
			<bpel:sources>
				<bpel:source linkName="receive-to-response">
					<!-- 
					<bpel:transitionCondition>
						$request1.request/amount >= 10000
					</bpel:transitionCondition>
					 -->
				</bpel:source>
			</bpel:sources>
		</bpel:receive>
		<!-- Build and send response -->
		
		<bpel:sequence>
			<bpel:targets>
				<bpel:target linkName="receive-to-response" />
			</bpel:targets>
			
			<!-- assign empty items array to the find-room request variable -->
			<bpel:assign>
				<bpel:copy>
					<bpel:from>
						<bpel:literal>
							<hos:Items>
							</hos:Items>
						</bpel:literal>
					</bpel:from>
					</bpel:to variable="findRoomRequest" part="items"/>
				</bpel:copy>
			</bpel:assign>
			
			<!-- TODO copy the items array from the original request to the findRoomRequest
			<bpel:assign>
				<bpel:copy>
					<bpel:from variable="originalRequest" part="treatmentPlan"
						query="/hos:SchedulingRequest/hos:Items" />
					<bpel:to variable="findRoomRequest"/>
				</bpel:copy>
			</bpel:assign> -->
			
			<!-- invoke the room service to find a room with our findRoomRequest variable -->
			<bpel:invoke partnerLink="link_room" portType="room:room"
				operation="findRoom" inputVariable="findRoomRequest" outputVariable="findRoomResponse" />
			
			
			<bpel:assign>
				<bpel:copy>
					<bpel:from>
						<bpel:literal>
							<hos:SchedulingResponse>
								<hos:PatientID>1</hos:PatientID>
								<hos:RoomID>2</hos:RoomID>
								<hos:DoctorID>3</hos:DoctorID>
								<hos:Duration>PT2H</hos:Duration>
								<hos:When>1995-05-03T08:00:00</hos:When>
							</hos:SchedulingResponse>
						</bpel:literal>
					</bpel:from>
					<bpel:to>$finalAnswer.treatmentSchedule</bpel:to>
				</bpel:copy>
			</bpel:assign>
			<bpel:reply partnerLink="link_scheduler" portType="sched:scheduling" operation="scheduleTreatment" variable="finalAnswer" />
		</bpel:sequence>
	</bpel:flow>
</bpel:process>
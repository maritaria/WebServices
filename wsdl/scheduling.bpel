<!-- loanapproval BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Wed Jan 18 15:24:37 CET 2012 -->
<bpel:process name="loanapproval" targetNamespace="http://loans.org/loan"
	suppressJoinFailure="yes" xmlns:lns="http://loans.org/loan"
	xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
	xmlns:rk="http://loans.org/risk" xmlns:ap="http://loans.org/approval">

	<!-- Import the client WSDL -->
	<bpel:import location="loan.wsdl" namespace="http://loans.org/loan"
		importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="risk.wsdl" namespace="http://loans.org/risk"
		importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="approval.wsdl" namespace="http://loans.org/approval"
		importType="http://schemas.xmlsoap.org/wsdl/" />

	<bpel:partnerLinks>
		<bpel:partnerLink name="customer" partnerLinkType="lns:loanPartnerLinkType"
			myRole="loanService" />
		<bpel:partnerLink name="approver" partnerLinkType="ap:loanApprovalLinkType"
			partnerRole="approver" />
		<bpel:partnerLink name="assessor" partnerLinkType="rk:riskAssessmentLinkType"
			partnerRole="assessor" />
	</bpel:partnerLinks>

	<bpel:variables>
		<bpel:variable name="request1" messageType="lns:creditInformationMessage" />
		<bpel:variable name="request2" messageType="rk:creditInformationMessage" />
		<bpel:variable name="request3" messageType="ap:creditInformationMessage" />
		<bpel:variable name="risk" messageType="rk:riskAssessmentMessage" />
		<bpel:variable name="approval1" messageType="ap:approvalMessage" />
		<bpel:variable name="approval2" messageType="lns:approvalMessage" />
		<bpel:variable name="error" messageType="lns:errorMessage" />
	</bpel:variables>


	<!-- ================================================================= -->
	<!-- ORCHESTRATION LOGIC -->
	<!-- Set of activities coordinating the flow of messages across the -->
	<!-- services integrated within this business process -->
	<!-- ================================================================= -->
	<bpel:flow name="main">
		<bpel:links>
			<bpel:link name="receive-to-assess" />
			<bpel:link name="receive-to-approval" />
			<bpel:link name="approval-to-reply" />
			<bpel:link name="assess-to-setMessage" />
			<bpel:link name="setMessage-to-reply" />
			<bpel:link name="assess-to-approval" />
		</bpel:links>

		<bpel:receive partnerLink="customer" portType="lns:loanServicePT"
			operation="request" variable="request1" createInstance="yes">
			<bpel:sources>
				<bpel:source linkName="receive-to-assess">
					<bpel:transitionCondition>
						$request1.request/amount >= 10000
					</bpel:transitionCondition>
				</bpel:source>
				<bpel:source linkName="receive-to-approval">
					<bpel:transitionCondition>
						$request1.request/amount &lt; 10000
					</bpel:transitionCondition>
				</bpel:source>
			</bpel:sources>
		</bpel:receive>

		<bpel:sequence>
			<bpel:targets>
				<bpel:target linkName="receive-to-assess" />
			</bpel:targets>
			<bpel:sources>
				<bpel:source linkName="assess-to-setMessage">
					<bpel:transitionCondition>
						$risk.level='low'
					</bpel:transitionCondition>
				</bpel:source>
				<bpel:source linkName="assess-to-approval">
					<bpel:transitionCondition>
						$risk.level!='low'
					</bpel:transitionCondition>
				</bpel:source>
			</bpel:sources>

			<bpel:assign>
				<bpel:copy>
					<bpel:from>$request1.request</bpel:from>
					<bpel:to>$request2.request</bpel:to>
				</bpel:copy>
			</bpel:assign>
			<bpel:invoke partnerLink="assessor" portType="rk:riskAssessmentPT"
				operation="check" inputVariable="request2" outputVariable="risk" />
		</bpel:sequence>

		<bpel:sequence>
			<bpel:targets>
				<bpel:target linkName="receive-to-approval" />
				<bpel:target linkName="assess-to-approval" />
			</bpel:targets>
			<bpel:sources>
				<bpel:source linkName="approval-to-reply" />
			</bpel:sources>
			<bpel:assign>
				<bpel:copy>
					<bpel:from>$request1.request</bpel:from>
					<bpel:to>$request3.request</bpel:to>
				</bpel:copy>
			</bpel:assign>
			<bpel:invoke partnerLink="approver" portType="ap:loanApprovalPT"
				operation="approve" inputVariable="request3" outputVariable="approval1">
			</bpel:invoke>
			<bpel:assign>
				<bpel:copy>
					<bpel:from>$approval1.accept</bpel:from>
					<bpel:to>$approval2.accept</bpel:to>
				</bpel:copy>
			</bpel:assign>
		</bpel:sequence>

<bpel:assign>
		<bpel:targets>
			<bpel:target linkName="assess-to-setMessage" />
		</bpel:targets>
		<bpel:sources>
			<bpel:source linkName="setMessage-to-reply" />
		</bpel:sources>
            <bpel:copy>
				<bpel:from><bpel:literal>
				<lns:ApprovalResponse><lns:accept>yes</lns:accept></lns:ApprovalResponse>
				</bpel:literal>
                </bpel:from>
				<bpel:to part="accept" variable="approval2">
                </bpel:to>
			</bpel:copy>
		</bpel:assign>

		<bpel:reply partnerLink="customer" portType="lns:loanServicePT"
			operation="request" variable="approval2">
			<bpel:targets>
				<bpel:target linkName="setMessage-to-reply" />
				<bpel:target linkName="approval-to-reply" />
			</bpel:targets>
		</bpel:reply>

	</bpel:flow>

</bpel:process>


<!-- loanapproval BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Wed Jan 18 15:24:37 CET 2012 -->
<bpel:process name="scheduling" targetNamespace="http://hospital/scheduling/" suppressJoinFailure="yes" xmlns:sched="http://hospital/scheduling/" xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
	xmlns:plnk="http://docs.oasis-open.org/wsbpel/2.0/plnktype" xmlns:doctor="http://hospital/doctor/" xmlns:patient="http://hospital/patient/" xmlns:room="http://hospital/room/" xmlns:agenda="http://hospital/agenda/"
	xmlns:hos="http://hospital/schema/">

	<!-- Import the client WSDL -->
	<bpel:import location="room.wsdl" namespace="http://hospital/room/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="doctor.wsdl" namespace="http://hospital/doctor/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="patient.wsdl" namespace="http://hospital/patient/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="agenda.wsdl" namespace="http://hospital/agenda/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="scheduling.wsdl" namespace="http://hospital/scheduling/" importType="http://schemas.xmlsoap.org/wsdl/" />

	<!-- partner links TODO -->
	<bpel:partnerLinks>
		<bpel:partnerLink name="link_scheduler" partnerLinkType="sched:schedulingPartnerLinkType" myRole="schedulingService" />
		<bpel:partnerLink name="link_room" partnerLinkType="room:roomLinkType" partnerRole="room" />
	</bpel:partnerLinks>
	
	<!-- variables -->
	<bpel:variables>
		<bpel:variable name="originalRequest" messageType="sched:scheduleTreatmentRequest" />
		<bpel:variable name="finalAnswer" messageType="sched:scheduleTreatmentResponse" />
		<bpel:variable name="findRoomRequest" messageType="room:findRoomRequest" />
		<bpel:variable name="findRoomResponse" messageType="room:findRoomResponse" />
		
		<!-- room service, doctor service -->
		<!-- notifications -->
		<!-- callback, rescheduling notifies -->
	</bpel:variables>

	<!-- ================================================================= -->
	<!-- ORCHESTRATION LOGIC -->
	<!-- Set of activities coordinating the flow of messages across the -->
	<!-- services integrated within this business process -->
	<!-- ================================================================= -->
	<bpel:flow name="main">
		<bpel:links>
			<bpel:link name="receive-to-response" />
		</bpel:links>
		<!-- Receive initial request -->
		<bpel:receive partnerLink="link_scheduler" portType="sched:scheduling" operation="scheduleTreatment" variable="originalRequest" createInstance="yes">
			<bpel:sources>
				<bpel:source linkName="receive-to-response">
				</bpel:source>
			</bpel:sources>
		</bpel:receive>
		<bpel:sequence>
			<bpel:targets>
				<bpel:target linkName="receive-to-response" />
			</bpel:targets>
			<bpel:assign validate="no" name="Assign">
				<bpel:copy>
					<bpel:from>
						<bpel:literal>
							<tns:Items xmlns:tns="http://hospital/schema/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
								<tns:Item>tns:Item</tns:Item>
							</tns:Items>
						</bpel:literal>
					</bpel:from>
					<bpel:to variable="findRoomRequest" part="items"></bpel:to>
				</bpel:copy>
				<bpel:copy>
					<bpel:from part="treatmentPlan" variable="originalRequest">
						<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[hos:Items]]></bpel:query>
					</bpel:from>
					<bpel:to part="items" variable="findRoomRequest"></bpel:to>
				</bpel:copy>
			</bpel:assign>
			<bpel:invoke partnerLink="link_room" portType="room:room" operation="findRoom" inputVariable="findRoomRequest" outputVariable="findRoomResponse" />
			<bpel:assign>
				
                <bpel:copy>
                    <bpel:from><bpel:literal><tns:RoomIDs xmlns:tns="http://hospital/schema/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:RoomID>tns:RoomID</tns:RoomID>
</tns:RoomIDs>
</bpel:literal></bpel:from>
                    <bpel:to variable="finalAnswer" part="treatmentSchedule"></bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from part="roomIDs" variable="findRoomResponse"></bpel:from>
                    <bpel:to part="treatmentSchedule" variable="finalAnswer"></bpel:to>
                </bpel:copy>
            </bpel:assign>
			<bpel:reply partnerLink="link_scheduler" portType="sched:scheduling" operation="scheduleTreatment" variable="finalAnswer" />
		</bpel:sequence>
	</bpel:flow>
</bpel:process>
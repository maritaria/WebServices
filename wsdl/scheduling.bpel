<!-- loanapproval BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Wed Jan 18 15:24:37 CET 2012 -->
<bpel:process name="scheduling" targetNamespace="http://hospital/scheduling/" suppressJoinFailure="yes" xmlns:sched="http://hospital/scheduling/" xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
	xmlns:plnk="http://docs.oasis-open.org/wsbpel/2.0/plnktype" xmlns:doctor="http://hospital/doctor/" xmlns:patient="http://hospital/patient/" xmlns:room="http://hospital/room/" xmlns:agenda="http://hospital/agenda/"
	xmlns:hos="http://hospital/schema/">

	<!-- Import the client WSDL -->
	<bpel:import namespace="http://hospital/schema/" location="hospital.xsd" importType="http://www.w3.org/2001/XMLSchema"></bpel:import>
	<bpel:import location="room.wsdl" namespace="http://hospital/room/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="doctor.wsdl" namespace="http://hospital/doctor/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="patient.wsdl" namespace="http://hospital/patient/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="agenda.wsdl" namespace="http://hospital/agenda/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="scheduling.wsdl" namespace="http://hospital/scheduling/" importType="http://schemas.xmlsoap.org/wsdl/" />

	<!-- partner links TODO -->
	<bpel:partnerLinks>
		<bpel:partnerLink name="link_scheduler" partnerLinkType="sched:schedulingPartnerLinkType" myRole="schedulingService" />
		<bpel:partnerLink name="link_room" partnerLinkType="room:roomLinkType" partnerRole="room" />
		<bpel:partnerLink name="link_doctor" partnerLinkType="doctor:doctorLinkType" partnerRole="doctor"></bpel:partnerLink>
		<bpel:partnerLink name="link_agenda" partnerLinkType="agenda:agendaLinkType" partnerRole="agenda" myRole="agendaCallback"></bpel:partnerLink>
	</bpel:partnerLinks>
	
	<!-- variables -->
	<bpel:variables>
		<bpel:variable name="originalRequest" messageType="sched:scheduleTreatmentRequest" />
		<bpel:variable name="finalAnswer" messageType="sched:scheduleTreatmentResponse" />
		<bpel:variable name="findRoomRequest" messageType="room:findRoomRequest" />
		<bpel:variable name="findRoomResponse" messageType="room:findRoomResponse" />

		<bpel:variable name="findDoctorRequest" messageType="doctor:findDoctorRequest"></bpel:variable>
		<bpel:variable name="findDoctorResponse" messageType="doctor:findDoctorResponse"></bpel:variable>

		<bpel:variable name="agendaRequest" messageType="agenda:scheduleTreatmentRequest"></bpel:variable>
		<bpel:variable name="agendaCallback" messageType="agenda:receiveCallbackRequest"></bpel:variable>
	</bpel:variables>

	<!-- ================================================================= -->
	<!-- ORCHESTRATION LOGIC -->
	<!-- Set of activities coordinating the flow of messages across the -->
	<!-- services integrated within this business process -->
	<!-- ================================================================= -->
	<bpel:flow name="main">
		<bpel:links>
			<bpel:link name="receive-to-response" />
		</bpel:links>
		<!-- Receive initial request -->
		<bpel:receive partnerLink="link_scheduler" portType="sched:scheduling" operation="scheduleTreatment" variable="originalRequest" createInstance="yes">
			<bpel:sources>
				<bpel:source linkName="receive-to-response">
				</bpel:source>
			</bpel:sources>
		</bpel:receive>
		<bpel:sequence>
			<bpel:targets>
				<bpel:target linkName="receive-to-response" />
			</bpel:targets>
			<bpel:assign validate="no" name="Prepare-RoomService">
				<bpel:copy>
					<bpel:from>
						<bpel:literal>
							<tns:Items xmlns:tns="http://hospital/schema/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
								<tns:Item>tns:Item</tns:Item>
							</tns:Items>
						</bpel:literal>
					</bpel:from>
					<bpel:to variable="findRoomRequest" part="items"></bpel:to>
				</bpel:copy>
				<bpel:copy>
					<bpel:from part="treatmentPlan" variable="originalRequest">
						<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[hos:Items]]></bpel:query>
					</bpel:from>
					<bpel:to part="items" variable="findRoomRequest"></bpel:to>
				</bpel:copy>
			</bpel:assign>
			<bpel:invoke partnerLink="link_room" portType="room:room" operation="findRoom" inputVariable="findRoomRequest" outputVariable="findRoomResponse" name="Invoke-RoomService" />
			<bpel:assign name="Prepare-DoctorService">
				<bpel:copy>
					<bpel:from>
						<bpel:literal>
							<tns:Skills xmlns:tns="http://hospital/schema/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
								<tns:Skill>tns:Skill</tns:Skill>
							</tns:Skills>
						</bpel:literal>
					</bpel:from>
					<bpel:to variable="findDoctorRequest" part="skills"></bpel:to>
				</bpel:copy>
				<bpel:copy>
					<bpel:from part="treatmentPlan" variable="originalRequest">
						<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[hos:Skills]]></bpel:query>
					</bpel:from>
					<bpel:to part="skills" variable="findDoctorRequest"></bpel:to>
				</bpel:copy>
			</bpel:assign>
			<bpel:invoke name="Invoke-DoctorService" partnerLink="link_doctor" operation="findDoctor" inputVariable="findDoctorRequest" outputVariable="findDoctorResponse"></bpel:invoke>
			<bpel:assign validate="no" name="Prepare-AgendaService">
				
				
				
                <bpel:copy>
                    <bpel:from><bpel:literal><tns:AgendaRequest xmlns:tns="http://hospital/schema/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:SchedulingRequest>
    <tns:PatientID>tns:PatientID</tns:PatientID>
    <tns:Skills>
      <tns:Skill>tns:Skill</tns:Skill>
    </tns:Skills>
    <tns:Items>
      <tns:Item>tns:Item</tns:Item>
    </tns:Items>
    <Duration>P1D</Duration>
    <HighPriority>true</HighPriority>
  </tns:SchedulingRequest>
  <tns:RoomIDs>
    <tns:RoomID>tns:RoomID</tns:RoomID>
  </tns:RoomIDs>
  <tns:DoctorIDs>
    <tns:DoctorID>tns:DoctorID</tns:DoctorID>
  </tns:DoctorIDs>
</tns:AgendaRequest>
</bpel:literal></bpel:from>
                    <bpel:to variable="agendaRequest" part="treatmentPlan"></bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from part="treatmentPlan" variable="originalRequest"></bpel:from>
                    <bpel:to part="treatmentPlan" variable="agendaRequest">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[hos:SchedulingRequest]]></bpel:query>
                    </bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from part="roomIDs" variable="findRoomResponse"></bpel:from>
                    <bpel:to part="treatmentPlan" variable="agendaRequest">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[hos:RoomIDs]]></bpel:query>
                    </bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from part="doctorIDs" variable="findDoctorResponse"></bpel:from>
                    <bpel:to part="treatmentPlan" variable="agendaRequest">
                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[hos:DoctorIDs]]></bpel:query>
                    </bpel:to>
                </bpel:copy>
            </bpel:assign>
			<bpel:invoke name="Invoke-AgendaService" partnerLink="link_agenda" operation="scheduleTreatment" portType="agenda:agenda" inputVariable="agendaRequest"></bpel:invoke>
			<bpel:receive name="Receive-AgendaCallback" partnerLink="link_agenda" operation="receiveCallback" portType="agenda:agendaCallback" variable="agendaCallback"></bpel:receive>
            <bpel:assign validate="no" name="Prepare-Reply">
                
                <bpel:copy>
                    <bpel:from><bpel:literal><tns:AgendaCallback xmlns:tns="http://hospital/schema/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <ScheduleInfo>
    <tns:PatientID>tns:PatientID</tns:PatientID>
    <tns:DoctorID>tns:DoctorID</tns:DoctorID>
    <tns:RoomID>tns:RoomID</tns:RoomID>
    <When>2001-12-31T12:00:00</When>
  </ScheduleInfo>
  <RescheduledTreatment>
    <tns:PatientID>tns:PatientID</tns:PatientID>
    <tns:DoctorID>tns:DoctorID</tns:DoctorID>
    <tns:RoomID>tns:RoomID</tns:RoomID>
    <When>2001-12-31T12:00:00</When>
    <WhenOriginally>2001-12-31T12:00:00</WhenOriginally>
  </RescheduledTreatment>
</tns:AgendaCallback>
</bpel:literal></bpel:from>
                    <bpel:to variable="finalAnswer" part="treatmentSchedule"></bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from part="treatmentPlan" variable="agendaCallback"></bpel:from>
                    <bpel:to part="treatmentSchedule" variable="finalAnswer"></bpel:to>
                </bpel:copy>
            </bpel:assign>
            <bpel:reply partnerLink="link_scheduler" portType="sched:scheduling" operation="scheduleTreatment" variable="finalAnswer" />
		</bpel:sequence>
	</bpel:flow>
</bpel:process>